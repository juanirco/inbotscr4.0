import{ToolbarManager}from"./ToolbarManager.js";import{BlockManager}from"./BlockManager.js";import{ContentRenderer}from"./ContentRenderer.js";import{TextEditor}from"./TextEditor.js";import{DataManager}from"./DataManager.js";export class BlogVisualEditor{constructor(){this.editor=null,this.postId=window.postId||null,this.selectedBlock=null,this.selectedTextElement=null,this.toolbarManager=null,this.blockManager=null,this.contentRenderer=null,this.textEditor=null,this.dataManager=null,this.init()}init(){this.editor=document.getElementById("visualEditor"),this.editor&&(this.setupModules(),this.setupInitialState(),this.setupEventListeners(),this.dataManager.loadExistingContent())}setupModules(){const e=this.createCallbacks();this.toolbarManager=new ToolbarManager(this.editor,e),this.blockManager=new BlockManager(this.editor,e),this.contentRenderer=new ContentRenderer(e),this.textEditor=new TextEditor(e),this.dataManager=new DataManager(this.editor,e),this.toolbarManager.createSidebarToolbar()}createCallbacks(){return{createContentBlock:e=>this.contentRenderer.createContentBlock(e),setupBlockEvents:e=>this.contentRenderer.setupBlockEvents(e),createRow:()=>this.blockManager.createRow(),createColumn:()=>this.blockManager.createColumn(),updateColumnWidths:e=>this.blockManager.updateColumnWidths(e),showAddContentButton:()=>this.blockManager.showAddContentButton(),updateContentBlocks:()=>this.dataManager.updateContentBlocks(),updateToolbarState:()=>this.toolbarManager.updateToolbarState(),applyBlockSize:(e,t)=>this.blockManager.applyBlockSize(e,t),applyBlockAlign:(e,t)=>this.blockManager.applyBlockAlign(e,t),duplicateBlock:e=>this.blockManager.duplicateBlock(e),deleteBlock:e=>this.blockManager.deleteBlock(e),handleTextFormat:(e,t)=>this.textEditor.handleTextFormat(e,t),applyTextColor:(e,t)=>this.textEditor.applyTextColor(e,t),applyTextSize:(e,t)=>this.textEditor.applyTextSize(e,t),applyTextAlign:(e,t)=>this.textEditor.applyTextAlign(e,t),replaceImage:e=>this.contentRenderer.replaceImage(e),loadGifPreview:(e,t)=>this.contentRenderer.loadGifPreview(e,t),loadVideoPreview:(e,t)=>this.contentRenderer.loadVideoPreview(e,t),onBlockSelected:e=>this.onBlockSelected(e),onBlockDeselected:()=>this.onBlockDeselected()}}setupInitialState(){this.editor.innerHTML="",this.blockManager.showAddContentButton()}setupEventListeners(){this.editor.addEventListener("click",e=>{const t=e.target.closest(".content-block");if(t){this.blockManager.selectBlock(t);const e=t.querySelector(".text-content");e?(this.selectedTextElement=e,this.toolbarManager.setSelectedTextElement(e)):(this.selectedTextElement=null,this.toolbarManager.setSelectedTextElement(null))}else this.deselectCurrentBlock()}),document.addEventListener("selectionchange",()=>{const e=window.getSelection();if(e.rangeCount>0){const t=e.getRangeAt(0),o=t.commonAncestorContainer.closest?t.commonAncestorContainer.closest(".text-content"):t.commonAncestorContainer.parentElement&&t.commonAncestorContainer.parentElement.closest(".text-content");if(o&&this.editor.contains(o)){this.selectedTextElement=o,this.toolbarManager.setSelectedTextElement(o);const e=o.closest(".content-block");e&&this.blockManager.selectBlock(e)}}}),document.addEventListener("input",e=>{this.editor.contains(e.target)&&this.dataManager.updateContentBlocks()}),document.addEventListener("click",e=>{this.editor.contains(e.target)||e.target.closest(".add-content-modal")||e.target.closest(".editor-sidebar-toolbar")||this.deselectCurrentBlock()}),document.addEventListener("keydown",e=>{if("Escape"===e.key){this.deselectCurrentBlock();const e=document.querySelector(".add-content-modal");e&&e.remove()}})}deselectCurrentBlock(){this.selectedBlock&&(this.blockManager.clearSelection(),this.onBlockDeselected())}onBlockSelected(e){this.selectedBlock=e,this.toolbarManager.setSelectedBlock(e),this.toolbarManager.updateToolbarState()}onBlockDeselected(){this.selectedBlock=null,this.selectedTextElement=null,this.toolbarManager.setSelectedBlock(null),this.toolbarManager.setSelectedTextElement(null),this.toolbarManager.updateToolbarState()}getEditorState(){return{hasContent:this.editor.children.length>0,selectedBlock:this.selectedBlock,selectedTextElement:this.selectedTextElement,totalBlocks:this.editor.querySelectorAll(".content-block").length,totalRows:this.editor.querySelectorAll(".content-row").length}}clearEditor(){confirm("¿Estás seguro de que quieres eliminar todo el contenido?")&&(this.editor.innerHTML="",this.selectedBlock=null,this.selectedTextElement=null,this.blockManager.showAddContentButton(),this.onBlockDeselected(),this.dataManager.updateContentBlocks())}prepareFormSubmission(){this.dataManager.prepareFormSubmission()}validateContent(){if(!this.getEditorState().hasContent)return alert("Por favor, agrega al menos un bloque de contenido antes de guardar."),!1;const e=this.editor.querySelectorAll(".content-block"),t=[];if(e.forEach((e,o)=>{let n=!1;switch(e.dataset.type){case"text":const t=e.querySelector(".text-content");n=!t||!t.textContent.trim();break;case"image":const o=e.querySelector("img");n=!o||!o.src;break;case"gif":case"video":const a=e.querySelector('input[type="url"]');n=!a||!a.value.trim();break;case"code":const l=e.querySelector("textarea");n=!l||!l.value.trim();break;case"quote":const r=e.querySelector(".quote-text");n=!r||!r.textContent.trim();break;case"card":const s=e.querySelector(".card-body");n=!s||!s.textContent.trim();break;default:n=!1}n&&t.push(o+1)}),t.length>0){const e=1===t.length?`El bloque ${t[0]} está vacío. Por favor, complétalo antes de guardar.`:`Los bloques ${t.join(", ")} están vacíos. Por favor, complétalos antes de guardar.`;return alert(e),!1}return!0}setupFormValidation(){const e=document.querySelector("form");e&&e.addEventListener("submit",e=>{if(!this.validateContent())return e.preventDefault(),!1;this.prepareFormSubmission()})}}